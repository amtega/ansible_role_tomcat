---
# Tasks for testing role

- name: run idempotence test
  hosts: localhost
  roles:
    - role: amtega.docker_presets
      docker_presets_images_json_query: >-
        [? starts_with(name, `centos-6`)
           || starts_with(name, `centos-7`)
           || starts_with(name, `fedora-27`)
           || starts_with(name, `fedora-28`) ]

    - role: amtega.docker_sandbox
      docker_sandbox_state: started
  tags:
    - sandbox

- name: test tomcat role instance provisioning
  hosts: docker_sandbox_containers
  roles:
    - role: amtega.tomcat
  vars:
    tomcat_instances:
      - name: tomcat@server1
        version: 8.0.9
        home: /opt/apache-tomcat-8.0.9
        base: /srv/tomcat/server1
        link: /opt/tomcat8
        user_uid: 3000
        user_soft_nofile: 1024
        user_hard_nofile: 1024
        user_soft_nproc: 500
        user_hard_nproc: 500
        group_uid: 3000
        server_port: 8005
        server_http_port: 8080
        server_https_port: 8443
        server_ajp_port: 8009
        manager_addresses_allow:
          - 192.168.5.2
          - 192.168.5.3
        manager_addresses_deny:
          - 192.168.5.13
          - 192.168.5.14
        manager_hostnames_allow:
          - host1.acme.com
          - host2.acme.com
        manager_hostnames_deny:
          - badhost1.acme.com
          - badhost2.acme.com
        realm:
          className: org.apache.catalina.realm.LockOutRealm
        subrealms:
          - className: org.apache.catalina.realm.JNDIRealm
            connectionURL: ldap://ldap.acme.com:389
            userBase: DC=acme,DC=com
            userSearch: "(cn={0})"
            userSubtree: true
            userRoleName: memberOf
            roleBase: DC=acme,DC=com
            roleName: cn
            roleSearch: "(member={0})"
            roleSubtree: true
            adCompat: true
            connectionName: myuser
            connectionPassword: mypassword
        cluster: true

      - name: tomcat@server2
        version: 8.0.9
        home: /opt/apache-tomcat-8.0.9
        base: /srv/tomcat/server2
        link: /opt/tomcat8
        user_uid: 3000
        group_uid: 3000
        server_port: 8006
        server_http_port: 8081
        server_https_port: 8444
        server_ajp_port: 8010
        cluster: true
        realm:
          className: org.apache.catalina.realm.LockOutRealm
        subrealms:
          - className: org.apache.catalina.realm.JNDIRealm
            connectionURL: ldap://ldap.acme.com:389
            userBase: DC=acme,DC=com
            userSearch: "(cn={0})"
            userSubtree: true
            userRoleName: memberOf
            roleBase: DC=acme,DC=com
            roleName: cn
            roleSearch: "(member={0})"
            roleSubtree: true
            adCompat: true
            connectionName: myuser
            connectionPassword: mypassword

      - name: tomcat@server3
        version: 7.0.88
        home: /opt/apache-tomcat-7.0.88
        base: /srv/tomcat/server3
        use_native_daemon: false
        java_variables:
          var1: VAR1
          var2: VAR2
        server_port: 8007
        server_http_port: 8082
        server_https_port: 8445
        server_ajp_port: 8011
        server_ajp_max_threads: 800
        server_engine_jvm_route: tomcat-server-2
        link: /opt/tomcat7
        realm:
          className: org.apache.catalina.realm.LockOutRealm
        subrealms:
          - className: org.apache.catalina.realm.JNDIRealm
            connectionURL: ldap://ldap.acme.com:389
            userBase: DC=acme,DC=com
            userSearch: "(cn={0})"
            userSubtree: true
            userRoleName: memberOf
            roleBase: DC=acme,DC=com
            roleName: cn
            roleSearch: "(member={0})"
            roleSubtree: true
            adCompat: true
            connectionName: myuser
            connectionPassword: mypassword

      - name: tomcat@server4
        version: 6.0.0
        home: /opt/apache-tomcat-6.0.0
        base: /srv/tomcat/server4
        server_port: 8008
        server_http_port: 8083
        server_https_port: 8446
        server_ajp_port: 8012
        server_autodeploy: false
        link: /opt/tomcat6
        artifact:
          type: http
          host: http://archive.apache.org
          path: /dist/tomcat/tomcat-6/v6.0.0/bin
          file: apache-tomcat-6.0.0.tar.gz
          dest: /tmp
        commons_daemon_download_url: >-
          http://archive.apache.org/dist/commons/daemon/source
        realm:
          className: org.apache.catalina.realm.UserDatabaseRealm
          resourceName: UserDatabase

    tomcat_instance_user_uid: 2000
    tomcat_instance_group_gid: 2000
  tasks:
    - name: read subrealm config
      xml:
        path: "{{ instance.base }}/conf/server.xml"
        xpath: >-
          {{ "/Server/Service[@name='Catalina']/Engine[@name='Catalina']"
             + "/Realm/Realm" }}
        content: attribute
      register: subrealm_result
      when: instance.subrealms is defined
      loop: "{{ tomcat_instances }}"
      loop_control:
        loop_var: instance
        label: "{{ instance.name }}"

    - name: assert subrealm config matches inventory
      assert:
        that:
          - file.className == inventory.className | string
          - file.connectionURL == inventory.connectionURL | string
          - file.userBase == inventory.userBase | string
          - file.userSearch == inventory.userSearch | string
          - file.userSubtree == inventory.userSubtree | string
          - file.userRoleName == inventory.userRoleName | string
          - file.roleBase == inventory.roleBase | string
          - file.roleName == inventory.roleName | string
          - file.roleSearch == inventory.roleSearch | string
          - file.roleSubtree == inventory.roleSubtree | string
          - file.adCompat == inventory.adCompat | string
          - file.connectionName == inventory.connectionName | string
          - file.connectionPassword == inventory.connectionPassword | string
      when: instance.subrealms is defined
      loop: "{{ tomcat_instances }}"
      loop_control:
        loop_var: instance
        index_var: index
        label: "{{ instance.name }}"
      vars:
        file: "{{ subrealm_result.results[index].matches[0].Realm }}"
        inventory: "{{ instance.subrealms[0] }}"

    - name: check that provisioned instances are listening
      wait_for:
        port: >-
          {{ item.0[item.1] | default(vars["tomcat_instance_" + item.1]) }}
        timeout: 5
      when: >-
        item.1 != "server_port"
        or (item.1 == "server_port"
            and (not item.0.use_native_daemon
                     | default(tomcat_instance_use_native_daemon)
                 or item.0.version is version("7", "<")))
      loop: "{{ query('nested', tomcat_instances, ports) }}"
      loop_control:
        label: "{{ item.0.name }} {{ item.1 }}"
      vars:
        ports:
          - server_port
          - server_http_port
          - server_ajp_port

    - name: check that provisioned instances http port is working
      uri:
        url: "http://localhost:{{ item.server_http_port }}"
        return_content: yes
      register: check_http_result
      failed_when: >-
         not check_http_result.content
             is search("successfully")
      loop: "{{ tomcat_instances }}"
      loop_control:
        label: "{{ item.name }}{{ item.server_http_port }}"
  tags:
    - idempotence

- name: test tomcat role instance removal
  hosts: docker_sandbox_containers
  roles:
    - role: amtega.tomcat
  vars:
    tomcat_instances:
      - name: tomcat@server1
        version: 8.0.9
        home: /opt/apache-tomcat-8.0.9
        base: /srv/tomcat/server1
        link: /opt/tomcat8
        state: absent
  tasks:
    - name: check server1 instance base dir
      stat:
        path: /srv/tomcat/tomcat@server1
      register: check_server1_base_result

    - name: check server1 instance home dir
      stat:
        path: /opt/apache-tomcat-8.0.9
      register: check_server1_home_result

    - name: check server1 instance base dir does not exist
      assert:
        that: not check_server1_base_result.stat.exists

    - name: check server1 instance home dir does not exist
      assert:
        that: not check_server1_home_result.stat.exists

- name: cleanup docker sandbox
  hosts: localhost
  roles:
    - role: amtega.docker_sandbox
      docker_sandbox_state: absent
  tags:
    - sandbox
