---
# Home directory install tasks

- block:
    - name: Setup tomcat home directory
      file:
        path: "{{ tomcat_home }}"
        state: directory
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_group }}"
        mode: "{{ tomcat_dir_permissions }}"

    - name: Setup tomcat home directory permissions
      shell: >-
        /usr/bin/find {{ tomcat_home }}
        -type d
        -exec chmod -v {{ tomcat_dir_permissions }} \{} \; ;

        /usr/bin/find {{ tomcat_home }}
        -type f
        -not -path {{ tomcat_home }}/bin/*
        -exec chmod -v {{ tomcat_file_permissions }} \{} \; ;

        for f in {{ tomcat_home }}/bin/*; do
          if [[ $f == *.sh ]] || [[ $f =~ .*/jsvc$ ]]; then
            chmod -v {{ tomcat_executable_permissions }} $f ;
          fi ;
        done
      args:
        warn: no
      register: tomcat_setup_dir_permissions
      changed_when: >-
        tomcat_setup_dir_permissions.stdout_lines
        | select("search", "changed from .* to .*")
        | list
        | length > 0
      environment:
        LANGUAGE: en_US

    - block:
        - name: Check tomcat home directory
          stat:
            path: "{{ tomcat_home }}/bin/catalina.sh"
          register: tomcat_home_check_result

        - include_tasks: artifact.yml
          vars:
            tomcat_artifact_state: "present"

        - name: Extract tomcat server package
          unarchive:
            src: "{{ tomcat_package }}"
            dest: "{{ tomcat_home }}"
            copy: no
            owner: "{{ tomcat_user }}"
            group: "{{ tomcat_group }}"
            mode: "{{ tomcat_file_permissions }}"
            extra_opts:
              - "--strip-components=1"
          register: tomcat_extract_daemon_package_result
          when: not tomcat_home_check_result.stat.exists
      when: >-
        tomcat_version
        is not version(ansible_local_facts.version | default(0), "==")
        or tomcat_force_install | bool
      vars:
        ansible_local_facts: >-
          {{ ansible_local[tomcat_name] | default({}) }}

    - name: Create tomcat home symlink
      file:
        src: "{{ tomcat_home }}"
        dest: "{{ tomcat_home_link }}"
        state: link
        mode: "{{ tomcat_file_permissions }}"
      when: tomcat_home_link is not none

    - include_tasks: artifact.yml
      vars:
        tomcat_artifact_state: "absent"

    - name: Setup tomcat home owner/group
      file:
        path: "{{ tomcat_home }}"
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_group }}"
        state: directory
      when: >-
        tomcat_user != ansible_local_facts.user | default(none)
        or tomcat_group != ansible_local_facts.group | default(none)
      vars:
        ansible_local_facts: >-
          {{ ansible_local[tomcat_name] | default({}) }}
  tags:
    - role::tomcat
    - role::tomcat::install
    - role::tomcat::install::home
